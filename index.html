<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Protected Editable Family Tree with Firebase</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      padding: 40px;
      background: #f7f9fb;
    }
    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    ul.family-tree, ul.family-tree ul {
      list-style: none;
      padding-left: 60px;
      position: relative;
      margin-left: 30px;
    }
    ul.family-tree {
      margin-left: 0;
      padding-left: 0;
    }
    ul.family-tree ul::before {
      content: "";
      position: absolute;
      top: 0;
      left: 16px;
      bottom: 0;
      width: 2px;
      background: #bbb;
    }
    li.member {
      margin: 20px 0;
      position: relative;
      padding-left: 36px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    li.member::before {
      content: "";
      position: absolute;
      top: 20px;
      left: 0;
      width: 20px;
      height: 2px;
      background: #bbb;
    }
    .member-name {
      padding: 10px 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      display: inline-block;
      user-select: none;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      font-weight: bold;
    }
    .member-name:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    ul.family-tree ul {
      display: none;
    }
    ul.family-tree ul.show {
      display: block;
    }
    /* Generation colors */
    .generation-0 .member-name { background: #ffe6e6; border-color: #ff9999; color: #a80000; }
    .generation-1 .member-name { background: #e6f2ff; border-color: #3399ff; color: #004d99; }
    .generation-2 .member-name { background: #e6ffe6; border-color: #66cc66; color: #267326; }
    .generation-3 .member-name { background: #fff5cc; border-color: #ffcc66; color: #a66b00; }
    .generation-4 .member-name { background: #f3e6ff; border-color: #b366ff; color: #5c00b3; }
    .generation-5 .member-name { background: #e6f7ff; border-color: #66d9ff; color: #007a99; }
    .generation-6 .member-name { background: #fff0f5; border-color: #ff99cc; color: #b30059; }
    .generation-7 .member-name { background: #f9fbe7; border-color: #d4e157; color: #827717; }
    .generation-8 .member-name { background: #ede7f6; border-color: #9575cd; color: #512da8; }
    .generation-9 .member-name { background: #e0f2f1; border-color: #4db6ac; color: #004d40; }

    /* Form and UI */
    #loginForm, #adminPanel {
      max-width: 400px;
      margin: 20px auto;
      padding: 20px;
      background: white;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    #loginForm label, #adminPanel label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    #loginForm input[type="password"],
    #adminPanel input[type="text"],
    #adminPanel select {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
    }
    button {
      padding: 10px 18px;
      font-size: 16px;
      background: #3399ff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #1a73e8;
    }
    #message, #loginMessage {
      text-align: center;
      margin-top: 10px;
      font-weight: 600;
    }
    #message { color: green; }
    #loginMessage { color: red; }
    .edit-btn {
      margin-left: 10px;
      padding: 3px 7px;
      font-size: 12px;
      background: #ffcc00;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .edit-input {
      font-size: 16px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #aaa;
      width: auto;
      min-width: 150px;
    }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

</head>
<body>

<h2>üå≥ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶∞‡¶ü‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶´‡ßç‡¶Ø‡¶æ‡¶Æ‡¶ø‡¶≤‡¶ø ‡¶ü‡ßç‡¶∞‡¶ø (Firebase ‡¶∏‡¶Ç‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§)</h2>

<!-- Login Form -->
<div id="loginSection">
  <form id="loginForm">
    <label for="passwordInput">‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®:</label>
    <input type="password" id="passwordInput" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°" required />
    <button type="submit">‡¶≤‡¶ó‡¶á‡¶®</button>
    <div id="loginMessage"></div>
  </form>
</div>

<!-- Admin Panel: Add & Edit -->
<div id="adminPanel" style="display:none;">
  <form id="addMemberForm">
    <label for="parentSelect">‡¶™‡¶ø‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®:</label>
    <select id="parentSelect" required></select>

    <label for="childName">‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡¶®‡ßç‡¶§‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:</label>
    <input type="text" id="childName" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" required />

    <button type="submit">Add Member</button>
    <div id="message"></div>
  </form>
  <button id="logoutBtn" style="margin-top:10px; background:#f44336;">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
</div>

<!-- Family Tree -->
<ul class="family-tree generation-0" id="familyTree" style="margin-top: 40px;">
  <!-- ‡¶ü‡ßç‡¶∞‡¶ø ‡¶°‡¶æ‡¶á‡¶®‡¶æ‡¶Æ‡¶ø‡¶ï‡¶≤‡¶ø ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá -->
</ul>

<script>
  // Firebase Config and Initialization
  const firebaseConfig = {
    apiKey: "AIzaSyC0Q9ay_ACVrsYx--8vUUbUR19m4SW78ck",
    authDomain: "family-tree-project-dccdd.firebaseapp.com",
    projectId: "family-tree-project-dccdd",
    storageBucket: "family-tree-project-dccdd.appspot.com",
    messagingSenderId: "623594594547",
    appId: "1:623594594547:web:db620880a1555a4ed61786",
    measurementId: "G-P5PT2WY16D"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const ADMIN_PASSWORD = "admin123";
  let isAdmin = false;
  let members = []; // ‡¶™‡ßÅ‡¶∞‡ßã ‡¶´‡ßç‡¶Ø‡¶æ‡¶Æ‡¶ø‡¶≤‡¶ø ‡¶ü‡ßç‡¶∞‡¶ø‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ

  // Toggle child UL on member-name click (only if NOT editing input)
  function setupToggle() {
    document.querySelectorAll('.member-name').forEach(member => {
      member.onclick = (e) => {
        if (e.target.classList.contains('edit-input')) return;
        if (e.target.tagName === 'BUTTON') return;
        const childrenUl = member.parentElement.querySelector('ul');
        if (childrenUl) {
          childrenUl.classList.toggle('show');
        }
        e.stopPropagation();
      };
    });
  }

  // Update parent select dropdown options
  function updateParentSelect() {
    const parentSelect = document.getElementById('parentSelect');
    parentSelect.innerHTML = '';
    members.forEach(m => {
      const option = document.createElement('option');
      option.value = m.id;
      option.textContent = `${m.name} (Generation ${m.generation})`;
      parentSelect.appendChild(option);
    });
  }

  // Build tree from data
  function buildTreeFromData(members) {
    const container = document.getElementById('familyTree');
    container.innerHTML = '';
    const rootMembers = members.filter(m => m.parentId === null);
    rootMembers.forEach(root => {
      const rootLi = createMemberLi(root, members);
      container.appendChild(rootLi);
    });
    setupToggle();
    setupEditButtons();
    updateParentSelect();
  }

  function createMemberLi(member, allMembers) {
    const li = document.createElement('li');
    li.classList.add('member');
    li.dataset.generation = member.generation;
    const div = document.createElement('div');
    div.className = `member-name generation-${member.generation}`;
    div.textContent = member.name + ' ';

    const editBtn = document.createElement('button');
    editBtn.textContent = 'Edit';
    editBtn.classList.add('edit-btn');
    editBtn.style.display = isAdmin ? 'inline-block' : 'none';
    div.appendChild(editBtn);

    li.appendChild(div);

    const children = allMembers.filter(m => m.parentId === member.id);
    if (children.length > 0) {
      const ul = document.createElement('ul');
      ul.classList.add(`generation-${member.generation + 1}`, 'show');
      children.forEach(child => {
        ul.appendChild(createMemberLi(child, allMembers));
      });
      li.appendChild(ul);
    }
    return li;
  }

  // Load family tree from Firestore
  async function loadFamilyTree() {
    try {
      const snapshot = await db.collection('familyTree').doc('main').get();
      if (!snapshot.exists) {
        // No data yet, initialize with default root member
        members = [{
          id: 'root',
          name: '‡¶ì‡¶Æ‡ßá‡¶¶ ‡¶Ü‡¶≤‡ßÄ',
          parentId: null,
          generation: 0
        }];
        await saveFamilyTree();
      } else {
        const data = snapshot.data();
        members = data.members || [];
      }
      buildTreeFromData(members);
    } catch (error) {
      console.error('Error loading family tree:', error);
    }
  }

  // Save family tree to Firestore
  async function saveFamilyTree() {
    try {
      await db.collection('familyTree').doc('main').set({ members });
    } catch (error) {
      console.error('Error saving family tree:', error);
    }
  }

  // Add member function (updates data and Firestore)
  async function addMember(parentId, childName) {
    const parent = members.find(m => m.id === parentId);
    if (!parent) return false;

    const newId = 'id-' + Date.now();
    const newMember = {
      id: newId,
      name: childName,
      parentId: parent.id,
      generation: parent.generation + 1
    };

    members.push(newMember);
    await saveFamilyTree();
    buildTreeFromData(members);
    return true;
  }

  // Setup Edit button click handlers
  function setupEditButtons() {
    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.onclick = (e) => {
        e.stopPropagation();
        const memberDiv = btn.parentElement;
        const liMember = memberDiv.parentElement;
        const memberGen = liMember.dataset.generation;

        if (memberDiv.querySelector('input.edit-input')) return;

        const oldName = memberDiv.childNodes[0].textContent.trim();

        const input = document.createElement('input');
        input.type = 'text';
        input.value = oldName;
        input.classList.add('edit-input');
        memberDiv.insertBefore(input, btn);
        memberDiv.childNodes[0].textContent = '';

        input.focus();

        // Save on blur or Enter
        function save() {
          const newName = input.value.trim();
          if (newName) {
            // Update member in members array
            const member = members.find(m => m.name === oldName && m.generation == memberGen);
            if (member) {
              member.name = newName;
              saveFamilyTree();
              buildTreeFromData(members);
            }
          }
          input.remove();
        }

        input.onblur = save;
        input.onkeydown = (ev) => {
          if (ev.key === 'Enter') {
            input.blur();
          } else if (ev.key === 'Escape') {
            input.value = oldName;
            input.blur();
          }
        };
      };
    });
  }

  // Show/hide admin UI based on login state
  function updateUI() {
    const loginSection = document.getElementById('loginSection');
    const adminPanel = document.getElementById('adminPanel');
    const allEditButtons = document.querySelectorAll('.edit-btn');

    if (isAdmin) {
      loginSection.style.display = 'none';
      adminPanel.style.display = 'block';
      allEditButtons.forEach(btn => btn.style.display = 'inline-block');
    } else {
      loginSection.style.display = 'block';
      adminPanel.style.display = 'none';
      allEditButtons.forEach(btn => btn.style.display = 'none');
    }
  }

  // Handle login
  document.getElementById('loginForm').addEventListener('submit', e => {
    e.preventDefault();
    const pw = document.getElementById('passwordInput').value;
    const loginMsg = document.getElementById('loginMessage');
    if (pw === ADMIN_PASSWORD) {
      isAdmin = true;
      updateUI();
      updateParentSelect();
      setupEditButtons();
      loginMsg.textContent = '';
    } else {
      loginMsg.textContent = '‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá!';
    }
    document.getElementById('passwordInput').value = '';
  });

  // Handle logout
  document.getElementById('logoutBtn').addEventListener('click', () => {
    isAdmin = false;
    updateUI();
  });

  // Add member form submit
  document.getElementById('addMemberForm').addEventListener('submit', async e => {
    e.preventDefault();
    if (!isAdmin) return;
    const parentId = document.getElementById('parentSelect').value;
    const childName = document.getElementById('childName').value.trim();
    const msg = document.getElementById('message');
    if (!childName) {
      msg.style.color = 'red';
      msg.textContent = '‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®‡•§';
      return;
    }
    if (!parentId) {
      msg.style.color = 'red';
      msg.textContent = '‡¶™‡¶ø‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
      return;
    }
    const success = await addMember(parentId, childName);
    if (success) {
      msg.style.color = 'green';
      msg.textContent = `'${childName}' ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`;
      document.getElementById('childName').value = '';
    } else {
      msg.style.color = 'red';
      msg.textContent = '‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá, ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
    }
  });

  // Initial load
  loadFamilyTree();
  updateUI();
</script>

</body>
</html>
